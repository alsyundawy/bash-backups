#!/bin/sh
# tadaen sylvemane | jason gibson
# loops through all folders in /home/* and checks
# if folder = actual user. creates directories and
# backs up as needed.
#
# requires dbus-x11 for the gsettings commands.

# variables

# determine version of linux used
DISTVERSION=$(grep ^ID= /etc/os-release | cut -d= -f2)
# hostname
LOCALHN=$(uname -n)
# backup target path
DESTPATH=/.localbackups/"$LOCALHN"
# number of full duplicity backups to keep before autoremoval
DUPFULL=3

# begin script #

# function #

mk_bu_dir() {
  if [ ! -d "$2" ] ; then
    mkdir -p "$2"
    chown "$1":"$1" "$2"
  fi
}

# check if target mountpoint. prevents backing up to main drive

mountpoint $(dirname "$DESTPATH") || exit 1

# make target directory as needed

[ -d "$DESTPATH"/"$DISTVERSION" ] || mkdir -p "$DESTPATH"/"$DISTVERSION"

# loop through users in /home/*

for user in /home/* ; do
  CURUSR=$(basename "$user")
  BUDIRPATH="$DESTPATH"/"$DISTVERSION"/"$CURUSR"
  # confirm folder = real user and is not a stray folder. clonezilla creates
  # a partimag folder in /home. this avoids such.
  grep "$CURUSR" < /etc/passwd || continue
  # create backup directory and chown to proper user
  mk_bu_dir "$CURUSR" "$BUDIRPATH"
  
  which duplicity && DUPBACK=y
  
  if [ "$DUPBACK" = y ] ; then
    su -c "duplicity \
    --full-if-older-than 30D \
    --no-encryption \
    --volsize=128 \
    --exclude-if-present .nobackup \
    /home/${CURUSR} \
    file://${BUDIRPATH}" "$CURUSR"
    # stage two clean duplicity backups
    su -c "duplicity \
      remove-all-but-n-full ${DUPFULL} \
      --force \
      file://${BUDIRPATH}" "$CURUSR"

    # stage three. set deja-dup to target backup folder so user doesn't have to
    # manually do it. this depends on deja-dup & dbus-x11 being installed
    which deja-dup && DEJABACK=y
	if [ "$DEJABACK" = y ] ; then
      su -c "dbus-launch gsettings set org.gnome.DejaDup backend local && \
      dbus-launch gsettings set org.gnome.DejaDup.Local folder ${BUDIRPATH}" \
      "$CURUSR"
    fi
  fi
done

# end script #
